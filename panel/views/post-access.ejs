<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaSal - G√∂nderi Eri≈üim Takibi</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>MetaSal</h2>
        </div>
        <ul class="nav-links">
            <li>
                <a href="/dashboard">üìä Dashboard</a>
            </li>
            <li>
                <a href="/profiles">üñ•Ô∏è Profiller</a>
            </li>
            <li>
                <a href="/targets">üìÑ Gruplar/Sayfalar</a>
            </li>
            <li>
                <a href="/posts">üìù G√∂nderiler</a>
            </li>
            <li>
                <a href="/comments">üí¨ Yorumlar</a>
            </li>
            <li>
                <a href="/fb-login">üîê Facebook Login</a>
            </li>
            <li class="active">
                <a href="/post-access">üìä G√∂nderi Eri≈üim Takibi</a>
            </li>
        </ul>
        <div class="sidebar-footer">
            <a href="/logout" class="logout-btn">üö™ √áƒ±kƒ±≈ü</a>
        </div>
    </nav>

    <main class="content">
        <div class="page-header">
            <h1>G√∂nderi Eri≈üim Takibi</h1>
            <p style="color:#666;margin-top:5px">Facebook g√∂nderilerinin eri≈üim sayƒ±larƒ±nƒ± takip edin ve Telegram
                bildirimleri alƒ±n.</p>
        </div>

        <!-- Telegram Konfig√ºrasyonu -->
        <div class="card">
            <div class="card-header">
                <h3>Telegram Konfig√ºrasyonu</h3>
            </div>
            <div class="card-body">
                <form action="/post-access/telegram-config" method="POST">
                    <div class="form-group">
                        <label for="botToken">Bot Token</label>
                        <input type="text" class="form-control" id="botToken" name="botToken"
                            value="<%= telegramConfig ? telegramConfig.botToken : '' %>"
                            placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                    </div>
                    <div class="form-group">
                        <label for="chatId">Chat ID</label>
                        <input type="text" class="form-control" id="chatId" name="chatId"
                            value="<%= telegramConfig ? telegramConfig.chatId : '' %>" placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="isActive" value="true" <%=telegramConfig &&
                                telegramConfig.isActive ? 'checked' : '' %>>
                            Aktif
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </form>
            </div>
        </div>

        <!-- Profil Se√ßimi -->
        <div class="card">
            <div class="card-header">
                <h3>Vision Profil Se√ßimi</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="folderId">Vision Folder ID</label>
                    <input type="text" class="form-control" id="folderId" placeholder="Folder UUID'sini girin">
                    <small class="form-text text-muted">Folder ID girdikten sonra profiller y√ºklenecek</small>
                </div>
                <div class="form-group" id="profileSelection" style="display: none;">
                    <label for="selectedProfile">Profil Se√ßin</label>
                    <select class="form-control" id="selectedProfile">
                        <option value="">-- Profil Se√ßin --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- URL Y√∂netimi -->
        <div class="card">
            <div class="card-header">
                <h3>URL Y√∂netimi</h3>
            </div>
            <div class="card-body">
                <!-- Yeni URL Ekle -->
                <form action="/post-access/add" method="POST" class="mb-3" id="addUrlForm">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="form-control" name="url" style="flex: 1;"
                            placeholder="Facebook g√∂nderi URL'si" required>
                        <input type="hidden" name="profileId" id="profileIdInput">
                        <button type="submit" class="btn btn-primary">Ekle</button>
                    </div>
                    <small class="form-text text-muted">
                        √ñnce yukarƒ±dan bir profil se√ßin, sonra URL ekleyin
                    </small>
                </form>

                <!-- URL Listesi -->
                <% if (tracks && tracks.length> 0) { %>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Profil</th>
                                <th>Durum</th>
                                <th>Eri≈üim</th>
                                <th>Son Kontrol</th>
                                <th>Aksiyonlar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% tracks.forEach(track=> { %>
                                <tr>
                                    <td>
                                        <a href="<%= track.url %>" target="_blank"
                                            style="max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            <%= track.url %>
                                        </a>
                                    </td>
                                    <td>
                                        <%= track.profile.name %>
                                    </td>
                                    <td>
                                        <% if (track.status==='active' ) { %>
                                            <span class="status-badge success">Aktif</span>
                                            <% } else if (track.status==='paused' ) { %>
                                                <span class="status-badge warning">Duraklatƒ±ldƒ±</span>
                                                <% } else if (track.status==='link_added' ) { %>
                                                    <span class="status-badge info">Link Eklendi</span>
                                                    <% } %>
                                    </td>
                                    <td>
                                        <%= track.currentReach.toLocaleString('tr-TR') %>
                                    </td>
                                    <td>
                                        <%= track.lastCheckedAt %>
                                    </td>
                                    <td class="actions">
                                        <% if (track.status==='active' ) { %>
                                            <button class="btn btn-sm btn-warning"
                                                onclick="toggleStatus(<%= track.id %>, 'paused')">
                                                Duraklat
                                            </button>
                                            <% } else if (track.status==='paused' ) { %>
                                                <button class="btn btn-sm btn-primary"
                                                    onclick="toggleStatus(<%= track.id %>, 'active')">
                                                    Aktifle≈ütir
                                                </button>
                                                <% } %>

                                                    <% if (track.status !=='link_added' ) { %>
                                                        <button class="btn btn-sm"
                                                            style="background: #17a2b8; color: white;"
                                                            onclick="markLinkAdded(<%= track.id %>)">
                                                            Link Eklendi
                                                        </button>
                                                        <% } %>

                                                            <button class="btn btn-sm btn-danger"
                                                                onclick="deleteUrl(<%= track.id %>)">
                                                                Sil
                                                            </button>
                                    </td>
                                </tr>
                                <% }); %>
                        </tbody>
                    </table>
                    <% } else { %>
                        <p style="color: #666; text-align: center; padding: 20px;">
                            Hen√ºz takip edilen URL yok.
                        </p>
                        <% } %>
            </div>
        </div>
    </main>

    <script>
        let selectedProfileId = null;

        // Folder ID deƒüi≈ütiƒüinde profilleri y√ºkle (input event kullan - her karakter giri≈üinde tetiklenir)
        document.getElementById('folderId').addEventListener('input', async function () {
            const folderId = this.value.trim();

            if (!folderId) {
                document.getElementById('profileSelection').style.display = 'none';
                return;
            }

            // Minimum uzunluk kontrol√º (folder ID genelde UUID formatƒ±nda)
            if (folderId.length < 10) {
                return; // Hen√ºz tam ID girilmemi≈ü
            }

            console.log('Folder ID ile profil aranƒ±yor:', folderId);

            try {
                const response = await fetch(`/post-access/profiles/${encodeURIComponent(folderId)}`);
                const data = await response.json();

                console.log('API Response:', data);

                if (data.success && data.profiles && data.profiles.length > 0) {
                    const select = document.getElementById('selectedProfile');
                    select.innerHTML = '<option value="">-- Profil Se√ßin --</option>';

                    data.profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = `${profile.name} (${profile.status})`;
                        select.appendChild(option);
                    });

                    document.getElementById('profileSelection').style.display = 'block';
                    console.log(`${data.profiles.length} profil bulundu`);
                } else {
                    console.warn('Profil bulunamadƒ±:', data);
                    document.getElementById('profileSelection').style.display = 'none';
                    alert('Bu klas√∂rde profil bulunamadƒ±. Console\'u kontrol edin.');
                }
            } catch (error) {
                console.error('Profil y√ºkleme hatasƒ±:', error);
                alert('Profiller y√ºklenirken hata olu≈ütu: ' + error.message);
            }
        });


        // Profil se√ßildiƒüinde
        document.getElementById('selectedProfile').addEventListener('change', function () {
            selectedProfileId = this.value;
            document.getElementById('profileIdInput').value = selectedProfileId;
        });

        // Form submit kontrol√º
        document.getElementById('addUrlForm').addEventListener('submit', function (e) {
            if (!selectedProfileId) {
                e.preventDefault();
                alert('L√ºtfen √∂nce bir profil se√ßin');
            }
        });

        // URL durumunu deƒüi≈ütir
        async function toggleStatus(id, newStatus) {
            try {
                const response = await fetch(`/post-access/${id}/toggle-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('Durum deƒüi≈ütirilemedi');
                }
            } catch (error) {
                console.error('Durum deƒüi≈ütirme hatasƒ±:', error);
                alert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu');
            }
        }

        // Link eklendi i≈üaretle
        async function markLinkAdded(id) {
            if (!confirm('Bu URL i√ßin "Link Eklendi" olarak i≈üaretlensin mi?')) {
                return;
            }

            try {
                const response = await fetch(`/post-access/${id}/mark-link-added`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('ƒ∞≈üaretleme ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                console.error('ƒ∞≈üaretleme hatasƒ±:', error);
                alert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu');
            }
        }

        // URL sil
        async function deleteUrl(id) {
            if (!confirm('Bu URL silinsin mi?')) {
                return;
            }

            try {
                const response = await fetch(`/post-access/${id}/delete`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('Silme ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                console.error('Silme hatasƒ±:', error);
                alert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu');
            }
        }
    </script>

    <style>
        .status-badge.success {
            background-color: #28a745;
            color: white;
        }

        .status-badge.warning {
            background-color: #ffc107;
            color: black;
        }

        .status-badge.info {
            background-color: #17a2b8;
            color: white;
        }
    </style>
</body>

</html>